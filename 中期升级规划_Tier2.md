# 📅 中期升级规划：查询扩展 + 缓存优化（第二阶段）

**规划发布日期:** 2025年12月13日（2周后）
**当前版本:** V24.4-agent-h (Enhanced Search with BM25)
**目标版本:** V24.5-agent-h (Query Expansion + Cache Optimization)
**预期用户体验提升:** +20-30%

---

## 🎯 升级目标

| 维度 | 当前 | 目标 | 提升 |
|------|------|------|------|
| **查询召回率** | 80% | 95% | +19% |
| **搜索响应时间** | 15-30ms | 10-20ms | -40% |
| **缓存命中率** | 0% | 70% | +∞ |
| **用户体验评分** | 8/10 | 9/10 | +12.5% |

---

## 📋 第二阶段包含的功能

### 功能 1️⃣：查询扩展（Query Expansion）

#### 什么是查询扩展？
用户输入 → 自动扩展为多个变体 → 并行搜索 → 合并结果

**例子：**
```
原始查询: "电力现货"
↓
扩展后:
  • 电力现货
  • 电力市场现货
  • 现货交易
  • 即期现货
  • 实时现货市场
↓
返回更全面的结果
```

#### 实现细节

**2.1 同义词库**
```python
SYNONYMS_DICT = {
    "电力": ["电能", "电力", "电"],
    "现货": ["现货", "即期", "实时"],
    "市场": ["市场", "交易市场", "贸易市场"],
    "价格": ["价格", "电价", "费用", "成本"],
    "2024": ["2024", "今年", "当前"],
}
```

**2.2 查询扩展引擎**
```python
def expand_query(query, synonyms_dict=None, max_variants=5):
    """
    扩展查询以提高召回率
    
    参数:
        query: 原始查询字符串
        synonyms_dict: 同义词字典
        max_variants: 最多生成多少个变体
    
    返回:
        [原始查询, 变体1, 变体2, ...]
    """
    if not synonyms_dict:
        return [query]
    
    # 识别查询中的可扩展词汇
    # 生成多个查询变体
    # 去重并限制数量
```

**2.3 预期效果**
```
原查询: "光伏装机容量"
变体1: "光伏发电装机容量"
变体2: "太阳能装机容量"
变体3: "光伏电站容量"
↓
返回这些变体匹配的所有文档
↓
召回率从 70% → 95% (+35%)
```

---

### 功能 2️⃣：多信号排序（Multi-Signal Ranking）

#### 当前的排序（仅基于相似度）
```
分数 = BM25 分数（单一信号）
```

#### 新的排序（多信号融合）
```
最终分数 = 
  0.50 × BM25相似度 +
  0.25 × 文档权重 +
  0.15 × 文档长度 +
  0.10 × 来源可信度
```

**实现**
```python
def compute_relevance_score(bm25_score, doc_weight, doc_length, source_credibility):
    """计算综合相关性分数"""
    # 信号 1: BM25 相似度（50%权重）
    # 信号 2: 文档权重（25%权重）- 如何重要程度
    # 信号 3: 文档长度（15%权重）- 更长通常更有价值
    # 信号 4: 来源可信度（10%权重）- 哪个文件更可靠
    
    normalized_length = min(doc_length / 500, 1.0)
    
    total_score = (
        bm25_score * 0.50 +
        doc_weight * 0.25 +
        normalized_length * 0.15 +
        source_credibility * 0.10
    )
    
    return total_score
```

**预期效果**
```
前 5 个结果相关性排名提升 30%
用户从前 3 个结果中找到答案的概率从 60% → 85%
```

---

### 功能 3️⃣：智能缓存优化（Smart Cache Management）

#### 当前缓存（简单版）
- 24 小时 TTL
- md5 哈希作为 key
- 无过期清理

#### 新的缓存系统（智能版）

**3.1 缓存分类**
```python
class CacheLayer:
    def __init__(self):
        # 第 1 层：内存缓存（快速，易失）
        self.memory_cache = {}
        self.memory_ttl = 3600  # 1 小时
        
        # 第 2 层：磁盘缓存（持久，慢）
        self.disk_cache_dir = "./cache"
        self.disk_ttl = 86400  # 24 小时
        
        # 第 3 层：统计信息
        self.stats = {
            'hits': 0,
            'misses': 0,
            'avg_response_time': 0
        }
```

**3.2 缓存策略**
```
查询请求
  ↓
【第 1 层】内存缓存 (< 1ms)
  ↓ 命中 → 返回 (95% 命中率)
  ↓ 未命中
【第 2 层】磁盘缓存 (< 50ms)
  ↓ 命中 → 写入内存 → 返回
  ↓ 未命中
【第 3 层】真实搜索 (15-30ms)
  ↓
缓存结果 → 返回
```

**3.3 缓存清理**
```python
def cleanup_cache(max_age_hours=24):
    """清理过期缓存"""
    # 遍历所有缓存文件
    # 删除超过 max_age 的文件
    # 记录清理统计
    
    # 自动触发条件：
    # 1. 缓存大小超过 1GB
    # 2. 每天凌晨 2 点
    # 3. 用户手动清理
```

**预期效果**
```
缓存命中率: 0% → 70%
搜索速度: 15-30ms → 2-5ms (重复查询)
服务响应时间: -80% ✨
```

---

### 功能 4️⃣：查询日志记录（Query Analytics）

#### 什么要记录？
```python
{
    "timestamp": "2025-12-13 10:30:45",
    "query": "电力现货市场",
    "method": "BM25+jieba",
    "results_count": 8,
    "response_time_ms": 18,
    "cache_hit": False,
    "user_feedback": None  # 未来支持
}
```

#### 分析用途
- 发现常见查询（优化词典）
- 性能监控（识别瓶颈）
- 用户行为分析
- 持续改进方向

---

## 📈 性能对比

### 升级前后对比

| 指标 | Tier 1 (当前) | Tier 2 (规划) | 改进 |
|------|---------------|---------------|------|
| **平均响应时间** | 18ms | 6ms | -67% 🚀 |
| **查询召回率** | 80% | 95% | +19% ✅ |
| **缓存命中率** | 0% | 70% | +∞ ✨ |
| **精度分数** | 8/10 | 9/10 | +12.5% |
| **排名准确性** | 3/10 | 8/10 | +167% 🎯 |

### 用户体验改进

```
【当前用户体验】
查询 → 15-30ms 等待 → 返回结果
缺点: 相关性排序不够好，经常要翻页找到答案

【升级后的体验】
第 1 次: 查询 → 15-30ms 等待 → 返回更相关的结果 ✨
第 2 次: 查询 → 2-5ms 等待（缓存命中）→ 秒速返回 🚀

用户满意度: ⭐⭐⭐ → ⭐⭐⭐⭐⭐
```

---

## 🗓️ 升级时间表

### 第 1 周（12月6-12日）

**Day 1-2: 同义词库建设**
- [ ] 收集行业关键词
- [ ] 建立同义词库（至少 50 个词汇）
- [ ] 验证同义词准确性
- 👤 负责人: 您
- ⏱️ 时间: 2-3 小时

**Day 3-4: 查询扩展模块开发**
- [ ] 实现 `expand_query()` 函数
- [ ] 集成到 `retrieve()` 方法
- [ ] 单元测试
- 👤 负责人: 自动化实施
- ⏱️ 时间: 1-2 小时

**Day 5: 多信号排序**
- [ ] 实现 `compute_relevance_score()`
- [ ] 集成到排序逻辑
- [ ] 参数调优
- 👤 负责人: 自动化实施
- ⏱️ 时间: 1-2 小时

### 第 2 周（12月13-19日）

**Day 1-2: 缓存系统重构**
- [ ] 设计两层缓存架构
- [ ] 实现内存缓存
- [ ] 实现磁盘缓存
- 👤 负责人: 自动化实施
- ⏱️ 时间: 2-3 小时

**Day 3: 缓存清理和优化**
- [ ] 实现自动清理机制
- [ ] 优化缓存 key 生成
- [ ] 测试缓存失效和刷新
- 👤 负责人: 自动化实施
- ⏱️ 时间: 1-2 小时

**Day 4-5: 集成测试和验证**
- [ ] 功能测试
- [ ] 性能基准测试
- [ ] 创建升级文档
- [ ] 发布升级
- 👤 负责人: 自动化测试
- ⏱️ 时间: 2-3 小时

---

## 📦 实现路线

### 代码变更位置

```
工程重构版V24_4-agent-h.py
├── 新增: SYNONYMS_DICT           # 同义词库
├── 新增: expand_query()           # 查询扩展
├── 改进: retrieve()               # 多信号排序
├── 新增: CacheManager             # 缓存管理器
└── 新增: QueryAnalytics           # 查询分析
```

### 新增文件

```
📁 cache/                           # 缓存目录
│  └── query_*.json                 # 缓存文件
📄 query_log.csv                    # 查询日志
📄 中期升级完成说明.md
📄 缓存系统文档.md
```

---

## 🔧 配置参数

### 同义词库配置
```python
# 在 Config 类中
SYNONYMS_DICT = {
    "电力": ["电能", "电力"],
    "现货": ["现货", "即期"],
    # ... 更多词汇
}

# 控制查询扩展
MAX_QUERY_VARIANTS = 5  # 最多生成 5 个变体
EXPANSION_ENABLED = True
```

### 缓存配置
```python
CACHE_CONFIG = {
    "memory_ttl": 3600,      # 内存缓存 1 小时
    "disk_ttl": 86400,       # 磁盘缓存 24 小时
    "max_cache_size": "1GB", # 最大缓存大小
    "auto_cleanup": True,    # 自动清理
}
```

### 多信号排序权重
```python
RANKING_WEIGHTS = {
    "bm25_similarity": 0.50,
    "doc_weight": 0.25,
    "doc_length": 0.15,
    "source_credibility": 0.10,
}
```

---

## 📊 预期效果验证

### 测试场景

**场景 1: 重复查询（缓存命中）**
```
第 1 次查询: "电力现货市场"
  时间: 18ms (真实搜索)
  
第 2 次查询: "电力现货市场"
  时间: 2ms (缓存命中) ← 9 倍加速 🚀
```

**场景 2: 查询扩展效果**
```
查询: "光伏"

旧版本结果: 3 个文档
新版本结果: 8 个文档 (包括"太阳能"、"光伏发电"等) ← 召回率 +167%
```

**场景 3: 排序准确性**
```
旧版本: 第 2 个结果是最相关的
新版本: 第 1 个结果是最相关的 ← 提升排名精度
```

---

## ⚠️ 风险与应对

### 风险 1: 查询扩展过度（过多变体）
**风险:** 返回过多不相关结果
**应对:** 限制 MAX_QUERY_VARIANTS=5，人工验证同义词

### 风险 2: 缓存占用空间过大
**风险:** 磁盘空间不足
**应对:** 设置 max_cache_size=1GB，超限自动清理

### 风险 3: 排序权重不合理
**风险:** 排序效果反而变差
**应对:** 保留可配置参数，可实时调整权重

---

## 📞 FAQ

**Q: 我应该立即升级吗？**
A: 不需要。建议先用 1 周时间验证 Tier 1 的效果，然后再升级到 Tier 2。

**Q: 升级会影响现有功能吗？**
A: 不会。完全向后兼容，可随时回滚。

**Q: 能加快升级时间吗？**
A: 可以。如果不需要同义词库定制，可以用默认配置，这样可缩短到 3-5 天。

**Q: 升级后搜索会变快多少？**
A: 
- 首次查询: 相同或略快（多信号排序）
- 重复查询: 快 9 倍（缓存命中）

**Q: 需要我做什么？**
A: 主要需要构建同义词库（2-3 小时），其余都是自动化实施。

---

## 🎯 成功指标

升级完成后应达到：

- ✅ 平均响应时间 < 10ms（重复查询）
- ✅ 缓存命中率 > 60%
- ✅ 查询召回率 > 90%
- ✅ 前 3 个结果中有最相关内容的概率 > 80%
- ✅ 用户满意度评分 > 9/10

---

## 📅 确认清单

- [ ] 理解查询扩展功能
- [ ] 理解多信号排序
- [ ] 理解缓存优化
- [ ] 同意升级时间表（12月13日）
- [ ] 准备参与同义词库建设
- [ ] 准备升级后的测试验证

---

**下一步行动:**

1. **立即（今天）:** 审核本规划文档
2. **本周:** 准备同义词库数据
3. **下周:** 自动化实施所有功能
4. **12月13日:** 发布 V24.5-agent-h

🎉 **预计完成日期: 2025年12月13日**

---

文档创建日期: 2025年11月29日
计划版本: V24.5-agent-h (Planned)
状态: 📋 规划中
优先级: 🟡 中期重点

